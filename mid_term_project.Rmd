---
title: "Project"
author: "Lijju Mathew"
date: "June 4, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

install.packages("GoodmanKruskal")

```{r library}
library(tidyverse)
library(ggplot2)
library(caTools)
library(dplyr)
library(magrittr)
library(readr)
library(survival)
library(nlme)
library(gridExtra) #grid.arrange()
library(class)
library(forcats)
library(MASS)
library(GGally)
library(tidyr)
library(maps)
library(mapproj)
library(stringr)
library(rmarkdown)
library(knitr)
library(jsonlite)
library(RCurl)
library(class)
library(httr)
library(mice)
library(corrplot)
library(GoodmanKruskal) # GKtauDataframe()
library(glmnet)
#library(moderndive) # get_regression_table()
#library(faraway)
#library(randomForest)
#library(e1071)
#library(naivebayes)
#library(caret)
#library(SuperLearner)
#library(psych)
#library(tm)
#library(VIM)


```

```{r datacleanup}
who_data <- read.csv(file.choose())
who_data <- who_data %>% filter(Year == 2014)
head(who_data)
summary(who_data)
str(who_data)

# Find the no of attributes with missing values
sort(sapply(who_data, function(x) sum(is.na(x))), decreasing = T)

#Missing data and percentage plot
missing.values <- who_data %>%
  gather(key = "key", value = "val") %>%
  dplyr::mutate(isna = is.na(val)) %>%
  dplyr::group_by(key) %>%
  dplyr::mutate(total = n()) %>%
  dplyr::group_by(key, total, isna)%>%
  dplyr::summarise(num.isna = n())%>%
  dplyr::mutate(pct = num.isna / total * 100)

levels <- (missing.values %>% filter(isna == T) %>% arrange(desc(pct)))$key

percentage.plot <- missing.values %>%
      ggplot() + geom_bar(aes(x = reorder(key, desc(pct)), y = pct, fill=isna), stat = 'identity', alpha=0.8) +
      scale_x_discrete(limits = levels) +
      scale_fill_manual(name = "", values = c('steelblue', 'tomato3'), labels = c("Present", "Missing")) +
      coord_flip() + 
      labs(title = "Percentage of missing values", x = 'Variable', y = "% of missing values")
percentage.plot

tempData <- mice(who_data,m=1,maxit=0,meth='fastpmm',seed=500)
who_imp <- complete(tempData,1)

sort(sapply(who_imp, function(x) sum(is.na(x))), decreasing = T)
glimpse(who_imp)
```

```{r split}
set.seed(10)
split_percent = .70
trainIndices = sample(1:dim(who_imp)[1],round(split_percent * dim(who_imp)[1]))
train = who_imp[trainIndices,]
test = who_imp[-trainIndices,]
summary(train)
```



```{r EDA EDA EDA}
summary(who_data)
who_imp_conti <- who_imp[, !sapply(who_imp, is.factor)]
who_imp_categ <- who_imp[, sapply(who_imp, is.factor)]

# Box plots to find outliers
boxplot(who_imp_conti[,2:20])
boxplot(who_imp_conti$Population)
who_imp[which.max(who_imp$Population),]

# ScatterPlot
head(who_imp_conti)
pairs(who_imp_conti[,2:20], pch=19)

# Computing the p value of correlations
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
p.mat <- cor.mtest(who_imp_conti[,2:20])
correlation <- cor(who_imp_conti[,2:20])
# Correlation plot with significance level of 0.05
corrplot(correlation, type="upper", order="hclust", p.mat = p.mat, sig.level = 0.05)

cat_cor<- GKtauDataframe(who_imp_categ)
plot(cat_cor, corrColors = "blue")
```

EDA
1. Out of total 183 countries, 151 countries are developing  and 32 are developed
2. Outliers - Population of India seemed as an outlier, but that is a fact.
3. Correlation 
    Percentage.expenditure - GDP
    Polio - Hepatitis.B, Diptheria
    Life.expectancy - Income.composition.of.resources, Schooling, Adult.Mortality, HIV.AIDS 
    Income.composition.of.resources - Schooling, Adult.Mortality, HIV.AIDS 
    Schooling - Adult.Mortality
    thinness..1.19.years - thinness..5.9.years
    Population - infant.deaths, under.five.deaths
    infant.deaths - under.five.deaths
4. Redundant/Unnecessary Variables -


```{r Full Model with all predictors}
model_full = lm(Life.expectancy ~ Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + Hepatitis.B + 
                Measles + BMI + under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + 
                Population + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + 
                Schooling,data=train)
scope_formula = formula(model_full)
scope_formula
forward_selection = step(object=model_full, scope=scope_formula, direction="stepwise")
summary(forward_selection)
plot(forward_selection)


forward_selection_aic = AIC(forward_selection)
forward_selection_aic # AIC of the model using forward selection method
```

From the Full Model the below are the significant predictors - Forward Selection
1.Adult.Mortality
2.Total.expenditure
3.HIV.AIDS
4.Income.composition.of.resources

Residual standard error: 3.404 on 109 degrees of freedom
Multiple R-squared:  0.8625,	Adjusted R-squared:  0.8398 

From the Full Model the below are the significant predictors - Backward Selection
1.Adult.Mortality
2.Total.expenditure
3.HIV.AIDS
4.Income.composition.of.resources

Residual standard error: 3.343 on 122 degrees of freedom
Multiple R-squared:  0.8516,	Adjusted R-squared:  0.8455 


From the Full Model the below are the significant predictors - Stepwise Selection
1.Adult.Mortality
2.Total.expenditure
3.HIV.AIDS
4.Income.composition.of.resources

Residual standard error: 3.343 on 122 degrees of freedom
Multiple R-squared:  0.8516,	Adjusted R-squared:  0.8455

dev.off()
```{r reduced model1- from manual selection, echo=FALSE}
reduced_model_1 <- lm(Life.expectancy~Schooling+Income.composition.of.resources+Alcohol+ HIV.AIDS, data=train)
get_regression_table(reduced_model_1)
summary(reduced_model_1)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(reduced_model_1, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)
vif(reduced_model_1)
plot(reduced_model_1)
# Scatterplot
pairs(data.frame(train$Schooling,train$Alcohol,train$Income.composition.of.resources,train$HIV.AIDS), pch=19)
```

From the Reduced Model (manual selection) the below are the significant predictors 
1.Income.composition.of.resources
2.HIV.AIDS
Residual standard error: 3.708 on 123 degrees of freedom
Multiple R-squared:  0.8159,	Adjusted R-squared:   0.81 
correlation        RMSE 
     0.8378      0.5866 
VIF
Schooling = 6.275441                 
Income.composition.of.resources = 6.636833                      
Alcohol = 1.571182         
HIV.AIDS = 1.254619

```{r reduced model2 - from stepwise selection, echo=FALSE}
reduced_model_2 <- lm(Life.expectancy~Adult.Mortality+Income.composition.of.resources+Total.expenditure+ HIV.AIDS, data=train)
get_regression_table(reduced_model_2)
summary(reduced_model_2)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(reduced_model_2, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)
vif(reduced_model_2)
plot(reduced_model_2)
# Scatterplot
pairs(data.frame(train$Adult.Mortality,train$Total.expenditure,train$Income.composition.of.resources,train$HIV.AIDS), pch=19)
```

From the Reduced Model (stepwise selection) the below are the significant predictors 
1.Adult.Mortality
2.Income.composition.of.resources 
3.Total.expenditure
4.HIV.AIDS

Residual standard error: 3.373 on 123 degrees of freedom
Multiple R-squared:  0.8477,	Adjusted R-squared:  0.8427
correlation        RMSE 
     0.8379      0.4089 
VIF
Adult.Mortality = 2.252322              
Income.composition.of.resources = 1.875678                    
Total.expenditure = 1.072145           
HIV.AIDS = 1.527980


```{r, LASSO  echo=T}
#Formatting data for GLM net
x=model.matrix(Life.expectancy ~ Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + Hepatitis.B + 
                Measles + BMI + under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + 
                Population + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + 
                Schooling, train)[,-1]
y=train$Life.expectancy

xtest<-model.matrix(Life.expectancy ~ Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + Hepatitis.B + 
                Measles + BMI + under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + 
                Population + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + 
                Schooling,test)[,-1]
ytest<-test$Life.expectancy

grid=10^seq(10,-2, length =100)
lasso.mod=glmnet(x,y,alpha=1, lambda =grid)

cv.out=cv.glmnet(x,y,alpha=1) #alpha=1 performs LASSO
plot(cv.out)
bestlambda<-cv.out$lambda.min  #Optimal penalty parameter.  You can make this call visually.
lasso.pred=predict (lasso.mod ,s=bestlambda ,newx=xtest)

testMSE_LASSO<-mean((ytest-lasso.pred)^2)
testMSE_LASSO
coef(lasso.mod,s=bestlambda)
```

Lasso Predictors ?
================
Adult.Mortality
Alcohol
percentage.expenditure
under.five.deaths
Total.expenditure
Diphtheria
HIV.AIDS
thinness.5.9.years
Income.composition.of.resources
Schooling







```{r lm model3, echo=FALSE}
model3<-lm(Life.expectancy~Schooling+Income.composition.of.resources+Total.expenditure+percentage.expenditure+BMI+Alcohol+GDP, data=who_imp)
get_regression_table(model3)
cor_table<-cor(who_imp[c(7,8,11,17,18,21,22)])
X3 <- model.matrix(model3)[,-1]
vif(X3)

# Model validation using test set
test$Life.expectancy.Predicted <- predict(model3, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)

# Model validation using train set
train$Life.expectancy.Predicted <- predict(model3, subset(train,select=-c(Country,Life.expectancy)))
train.correlation <- round(cor(train$Life.expectancy, train$Life.expectancy.Predicted),4)
train.RMSE <- round(sqrt(mean(train$Life.expectancy-train$Life.expectancy.Predicted)^2),4)
c(correlation = train.correlation, RMSE = train.RMSE)
```

```{r lm model4, echo=FALSE}
model4<-step(model3, data=who_imp, direction = "both", test="F")
get_regression_table(model4)
summary(model4)
X4 <- model.matrix(model4)[,-1]
vif(X4)
plot(model4)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(model4, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)

# Model validation using train set
train$Life.expectancy.Predicted <- predict(model4, subset(train,select=-c(Country,Life.expectancy)))
train.correlation <- round(cor(train$Life.expectancy, train$Life.expectancy.Predicted),4)
train.RMSE <- round(sqrt(mean(train$Life.expectancy-train$Life.expectancy.Predicted)^2),4)
c(correlation = train.correlation, RMSE = train.RMSE)
```

```{r lm model5, echo=FALSE}
model5<-lm(Life.expectancy~Schooling+Total.expenditure+percentage.expenditure+BMI+Alcohol+GDP, data=who_imp)
get_regression_table(model5)
X5 <- model.matrix(model5)[,-1]
vif(X5)

# Model validation using test set
test$Life.expectancy.Predicted <- predict(model5, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)

# Model validation using train set
train$Life.expectancy.Predicted <- predict(model5, subset(train,select=-c(Country,Life.expectancy)))
train.correlation <- round(cor(train$Life.expectancy, train$Life.expectancy.Predicted),4)
train.RMSE <- round(sqrt(mean(train$Life.expectancy-train$Life.expectancy.Predicted)^2),4)
c(correlation = train.correlation, RMSE = train.RMSE)
```

```{r lm model6, echo=FALSE}
model6<-step(model5, data=who_imp, direction = "both", test="F")
get_regression_table(model6)
summary(model6)

X6 <- model.matrix(model6)[,-1]
vif(X6)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(model6, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)

# Model validation using train set
train$Life.expectancy.Predicted <- predict(model6, subset(train,select=-c(Country,Life.expectancy)))
train.correlation <- round(cor(train$Life.expectancy, train$Life.expectancy.Predicted),4)
train.RMSE <- round(sqrt(mean(train$Life.expectancy-train$Life.expectancy.Predicted)^2),4)
c(correlation = train.correlation, RMSE = train.RMSE)
```

```{r}
library(texreg)
screenreg(list(model1, model2, model3, model4, model5, model6))
```

```{r knn}
# Train model with knn and get improtance of predictors
control <- trainControl(method="repeatedcv", number=10, repeats=3)
set.seed(6)
model.knn <- train( Life.expectancy ~ ., data=who_imp[,-c(2)], method="knn", trControl=control)
#Top 10 predictor ranking
importance.knn <- varImp(model.knn, scale=FALSE)
rank.knn <- importance.knn$importance
write.csv(rank.knn, "rank.knn.csv")
rank.knn <- read.csv("rank.knn.csv", header=TRUE)
colnames(rank.knn) <- c("Predictors", "Importance")
rank.knn <- rank.knn[order(rank.knn$Importance, decreasing = TRUE),]
ggplot(rank.knn[1:20,], aes(x=reorder(Predictors, Importance),y=Importance)) + geom_bar(stat = "identity") + coord_flip() + labs(title="Importance of Predictors", x="Predictors", y="Importance") +theme(axis.text.x=element_text(hjust=0.5, vjust=0.5, size = 12))+theme(axis.text.y=element_text(size = 12))
```

