---
title: "Project"
author: "Lijju Mathew"
date: "June 4, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

install.packages("GoodmanKruskal")

```{r library}
library(tidyverse)
library(ggplot2)
library(caTools)
library(dplyr)
library(magrittr)
library(readr)
library(survival)
library(nlme)
library(gridExtra) #grid.arrange()
library(class)
library(forcats)
library(MASS)
library(GGally)
library(tidyr)
library(maps)
library(mapproj)
library(stringr)
library(rmarkdown)
library(knitr)
library(jsonlite)
library(RCurl)
library(class)
library(httr)
library(mice)
library(corrplot)
library(GoodmanKruskal) # GKtauDataframe()
library(glmnet)
library(car)
library(moderndive) # get_regression_table()
library(faraway)
library(randomForest)
library(e1071)
library(naivebayes)
library(caret)
library(SuperLearner)
library(psych)
library(tm)
library(VIM)


```

```{r datacleanup}
#who_data <- read.csv(file.choose())
who_data <- read.csv("/Users/lijjumathew/Library/Mobile Documents/com~apple~CloudDocs/Lijju/SMU/Courses/Applied Statistics/Project/Life Expectancy Data")
who_data <- who_data %>% filter(Year == 2014)
head(who_data)
summary(who_data)
str(who_data)

# Find the no of attributes with missing values
sort(sapply(who_data, function(x) sum(is.na(x))), decreasing = T)

#Missing data and percentage plot
missing.values <- who_data %>%
  gather(key = "key", value = "val") %>%
  dplyr::mutate(isna = is.na(val)) %>%
  dplyr::group_by(key) %>%
  dplyr::mutate(total = n()) %>%
  dplyr::group_by(key, total, isna)%>%
  dplyr::summarise(num.isna = n())%>%
  dplyr::mutate(pct = num.isna / total * 100)

levels <- (missing.values %>% filter(isna == T) %>% arrange(desc(pct)))$key

percentage.plot <- missing.values %>%
      ggplot() + geom_bar(aes(x = reorder(key, desc(pct)), y = pct, fill=isna), stat = 'identity', alpha=0.8) +
      scale_x_discrete(limits = levels) +
      scale_fill_manual(name = "", values = c('steelblue', 'tomato3'), labels = c("Present", "Missing")) +
      coord_flip() + 
      labs(title = "Percentage of missing values", x = 'Variable', y = "% of missing values")
percentage.plot

tempData <- mice(who_data,m=1,maxit=0,meth='fastpmm',seed=500)
who_imp <- complete(tempData,1)

sort(sapply(who_imp, function(x) sum(is.na(x))), decreasing = T)
glimpse(who_imp)
```

```{r split}
set.seed(10)
split_percent = .70
trainIndices = sample(1:dim(who_imp)[1],round(split_percent * dim(who_imp)[1]))
train = who_imp[trainIndices,]
test = who_imp[-trainIndices,]
summary(train)
```



```{r EDA EDA EDA}
summary(who_data)
who_imp_conti <- who_imp[, !sapply(who_imp, is.factor)]
who_imp_categ <- who_imp[, sapply(who_imp, is.factor)]

# Box plots to find outliers
boxplot(who_imp_conti[,2:20])
boxplot(who_imp_conti$Population)
who_imp[which.max(who_imp$Population),]

# ScatterPlot
head(who_imp_conti)
pairs(who_imp_conti[,2:20], pch=19)

# Computing the p value of correlations
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
p.mat <- cor.mtest(who_imp_conti[,2:20])
correlation <- cor(who_imp_conti[,2:20])
# Correlation plot with significance level of 0.05
corrplot(correlation, type="upper", order="hclust", p.mat = p.mat, sig.level = 0.05)

cat_cor<- GKtauDataframe(who_imp_categ)
plot(cat_cor, corrColors = "blue")
```

EDA
1. Out of total 183 countries, 151 countries are developing  and 32 are developed
2. Outliers - Population of India seemed as an outlier, but that is a fact.
3. Correlation 
    Percentage.expenditure - GDP
    Polio - Hepatitis.B, Diptheria
    Life.expectancy - Income.composition.of.resources, Schooling, Adult.Mortality, HIV.AIDS 
    Income.composition.of.resources - Schooling, Adult.Mortality, HIV.AIDS 
    Schooling - Adult.Mortality
    thinness..1.19.years - thinness..5.9.years
    Population - infant.deaths, under.five.deaths
    infant.deaths - under.five.deaths
4. Redundant/Unnecessary Variables -

dev.off()

```{r Full Model with all predictors}
par(mfrow=c(2,2))
model_full = lm(Life.expectancy ~ Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + Hepatitis.B + 
                Measles + BMI + under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + 
                Population + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + 
                Schooling,data=train)
scope_formula = formula(model_full)
scope_formula
model_full_selection = step(object=model_full, scope=scope_formula, direction="both")
summary(model_full_selection)
plot(model_full_selection)

model_full_selection_aic = AIC(model_full_selection)
model_full_selection_bic = BIC(model_full_selection)
model_full_selection_aic # AIC of the model using forward selection method
model_full_selection_bic
```

From the Full Model the below are the significant predictors - Forward Selection
1.Adult.Mortality
2.Total.expenditure
3.HIV.AIDS
4.Income.composition.of.resources

Residual standard error: 3.404 on 109 degrees of freedom
Multiple R-squared:  0.8625,	Adjusted R-squared:  0.8398 
AIC=696.2527  BIC=753.2933

From the Full Model the below are the significant predictors - Backward Selection
1.Adult.Mortality
2.Total.expenditure
3.HIV.AIDS
4.Income.composition.of.resources

Residual standard error: 3.343 on 122 degrees of freedom
Multiple R-squared:  0.8516,	Adjusted R-squared:  0.8455 
AIC=680.0494  BIC=700.0137


From the Full Model the below are the significant predictors - Stepwise Selection
1.Adult.Mortality
2.Total.expenditure
3.HIV.AIDS
4.Income.composition.of.resources

Residual standard error: 3.343 on 122 degrees of freedom
Multiple R-squared:  0.8516,	Adjusted R-squared:  0.8455
AIC=680.0494  BIC=700.0137

dev.off()
```{r reduced model1- from manual selection, echo=FALSE}
par(mfrow=c(2,2))
reduced_model_1 <- lm(Life.expectancy~Schooling+Income.composition.of.resources+Alcohol+ HIV.AIDS, data=train)
get_regression_table(reduced_model_1)
summary(reduced_model_1)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(reduced_model_1, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)
vif(reduced_model_1)

reduced_model_1_aic = AIC(reduced_model_1)
reduced_model_1_bic = BIC(reduced_model_1)
reduced_model_1_aic # AIC of the model using forward selection method
reduced_model_1_bic

plot(reduced_model_1)
# Scatterplot
pairs(data.frame(train$Life.expectancy,train$Schooling,train$Alcohol,train$Income.composition.of.resources,train$HIV.AIDS), pch=19)
```

From the Reduced Model (manual selection) the below are the significant predictors 
1.Income.composition.of.resources
2.HIV.AIDS
Residual standard error: 3.708 on 123 degrees of freedom
Multiple R-squared:  0.8159,	Adjusted R-squared:   0.81 
correlation        RMSE 
     0.8378      0.5866 
VIF
Schooling = 6.275441                 
Income.composition.of.resources = 6.636833                      
Alcohol = 1.571182         
HIV.AIDS = 1.254619
AIC=705.623  BIC=722.7352

dev.off()

```{r reduced model2 - from stepwise selection, echo=FALSE}
par(mfrow=c(2,2))
reduced_model_2 <- lm(Life.expectancy~Adult.Mortality+Income.composition.of.resources+Total.expenditure+ HIV.AIDS, data=train)
get_regression_table(reduced_model_2)
summary(reduced_model_2)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(reduced_model_2, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)
vif(reduced_model_2)
plot(reduced_model_2)
reduced_model_2_aic = AIC(reduced_model_2)
reduced_model_2_bic = BIC(reduced_model_2)
reduced_model_2_aic # AIC of the model using forward selection method
reduced_model_2_bic
# Scatterplot
pairs(data.frame(train$Life.expectancy, train$Adult.Mortality,train$Total.expenditure,train$Income.composition.of.resources,train$HIV.AIDS), pch=19)
```

From the Reduced Model (stepwise selection) the below are the significant predictors 
1.Adult.Mortality
2.Income.composition.of.resources 
3.Total.expenditure
4.HIV.AIDS

Residual standard error: 3.373 on 123 degrees of freedom
Multiple R-squared:  0.8477,	Adjusted R-squared:  0.8427
correlation        RMSE 
     0.8379      0.4089 
VIF
Adult.Mortality = 2.252322              
Income.composition.of.resources = 1.875678                    
Total.expenditure = 1.072145           
HIV.AIDS = 1.52798
AIC=681.3944  BIC=698.5066

dev.off()

```{r, LASSO  echo=T}
#Formatting data for GLM net
x=model.matrix(Life.expectancy ~ Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + Hepatitis.B + 
                Measles + BMI + under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + 
                Population + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + 
                Schooling, train)[,-1]
y=train$Life.expectancy

xtest<-model.matrix(Life.expectancy ~ Adult.Mortality + infant.deaths + Alcohol + percentage.expenditure + Hepatitis.B + 
                Measles + BMI + under.five.deaths + Polio + Total.expenditure + Diphtheria + HIV.AIDS + GDP + 
                Population + thinness..1.19.years + thinness.5.9.years + Income.composition.of.resources + 
                Schooling,test)[,-1]
ytest<-test$Life.expectancy

grid=10^seq(10,-2, length =100)
lasso.mod=glmnet(x,y,alpha=1, lambda =grid)

cv.out=cv.glmnet(x,y,alpha=1) #alpha=1 performs LASSO
plot(cv.out)
bestlambda<-cv.out$lambda.min  #Optimal penalty parameter.  You can make this call visually.
lasso.pred=predict (lasso.mod ,s=bestlambda ,newx=xtest)

testMSE_LASSO<-mean((ytest-lasso.pred)^2)
testMSE_LASSO
coef(lasso.mod,s=bestlambda)
```

Lasso Predictors 
================
Adult.Mortality
Alcohol
percentage.expenditure
under.five.deaths
Total.expenditure
Diphtheria
HIV.AIDS
thinness.5.9.years
Income.composition.of.resources
Schooling

dev.off()

```{r reduced model3 - from Lasso selection, echo=FALSE}
par(mfrow=c(2,2))
reduced_model_3 <- lm(Life.expectancy ~ Adult.Mortality + Alcohol + percentage.expenditure + under.five.deaths + Total.expenditure + Diphtheria + HIV.AIDS +  thinness.5.9.years + Income.composition.of.resources + Schooling,data=train)
get_regression_table(reduced_model_3)
summary(reduced_model_3)
# Model validation using test set
test$Life.expectancy.Predicted <- predict(reduced_model_3, subset(test,select=-c(Country,Life.expectancy)))
test.correlation <- round(cor(test$Life.expectancy, test$Life.expectancy.Predicted),4)
test.RMSE <- round(sqrt(mean(test$Life.expectancy-test$Life.expectancy.Predicted)^2),4)
c(correlation = test.correlation, RMSE = test.RMSE)
vif(reduced_model_3)
plot(reduced_model_3)
reduced_model_3_aic = AIC(reduced_model_3)
reduced_model_3_bic = BIC(reduced_model_3)
reduced_model_3_aic # AIC of the model using forward selection method
reduced_model_3_bic
# Scatterplot
#pairs(data.frame(train$Life.expectancy,train$Adult.Mortality,train$Total.expenditure,train$Income.composition.of.resources,train$HIV.AIDS), pch=19)
```

dev.off()

```{r model4 - Life Expectancy differences between developed and devloping countries, echo=FALSE}
par(mfrow=c(2,2))
reduced_model_4 <- lm(Life.expectancy ~ Status ,data=who_data)
get_regression_table(reduced_model_4)
summary(reduced_model_4)
```
(Intercept)        81.138      1.298  62.493  < 2e-16 ***
StatusDeveloping  -11.636      1.429  -8.141 6.17e-14 ***

1. The P value of dummy variable StatusDeveloping is very significant suggesting that 
  there is statistical evidence of difference in average life expectancy between developing and developed countries.
2. The average life expectancy in developed countries is estimated to be 81.138
3. The average life expectancy in developing countries is 11.638 years less than developed countries.


```{r}
library(texreg)
screenreg(list(model1, model2, model3, model4, model5, model6))
```

```{r knn with all the predictors}
# Train model with knn and get importance of predictors
control <- trainControl(method="repeatedcv", number=10, repeats=3)
set.seed(6)
model.knn <- train( Life.expectancy ~ ., data=who_imp[,-c(2)], method="knn", trControl=control)
#Top 10 predictor ranking
importance.knn <- varImp(model.knn, scale=FALSE)
rank.knn <- importance.knn$importance
write.csv(rank.knn, "rank.knn.csv")
rank.knn <- read.csv("rank.knn.csv", header=TRUE)
colnames(rank.knn) <- c("Predictors", "Importance")
rank.knn <- rank.knn[order(rank.knn$Importance, decreasing = TRUE),]
ggplot(rank.knn[1:20,], aes(x=reorder(Predictors, Importance),y=Importance)) + geom_bar(stat = "identity") + coord_flip() + labs(title="Importance of Predictors", x="Predictors", y="Importance") +theme(axis.text.x=element_text(hjust=0.5, vjust=0.5, size = 12))+theme(axis.text.y=element_text(size = 12))
```



